<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Matrix Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inter font for clean, legible UI text -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------------- Theme tokens ---------------- */
    :root {
      --bg: #0f172a;      /* deep slate gradient start */
      --card: #fff;       /* card surface */
      --text: #0b1220;    /* primary text */
      --muted: #6b7280;   /* secondary text */
      --accent: #2563eb;  /* primary accent (blue) */
      --accent-2: #0ea5e9;/* secondary accent (cyan) */
      --danger: #dc2626;  /* error color */
      --shadow: 0 10px 24px rgba(15,23,42,.12);
      --radius: 16px;     /* rounded corners */
    }

    /* ---------------- Base layout ---------------- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      /* soft abstract background */
      background:
        radial-gradient(1000px 1000px at 20% -10%, rgba(37,99,235,.25), transparent 40%),
        radial-gradient(1000px 1000px at 120% 0%, rgba(14,165,233,.15), transparent 40%),
        #f5f7fb;
      color: var(--text);
    }
    .shell { max-width: 720px; margin: 48px auto; padding: 0 20px; }

    /* ---------------- Header ---------------- */
    .header {
      background: linear-gradient(135deg, var(--bg), #1e293b);
      color: #fff;
      border-radius: var(--radius);
      padding: 24px 28px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand {
      display: flex; align-items: center; gap: .75rem;
      font-weight: 700; font-size: 20px; letter-spacing: .2px;
    }
    .brand-logo { width: 42px; height: auto; display: block; }

    .back-link { color: #cbd5e1; text-decoration: none; font-size: 14px; }
    .back-link:hover { text-decoration: underline; }

    /* ---------------- Content card ---------------- */
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 28px; }
    h1 { margin: 0 0 20px; font-size: 24px; }

    /* ---------------- Form ---------------- */
    form { display: grid; gap: 18px; }
    label { font-weight: 600; margin-bottom: 6px; display: block; color: var(--muted); }

    /* Inputs: simple, accessible styling with visible focus */
    input {
      width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #d1d5db;
      font-size: 15px; transition: border .2s, box-shadow .2s;
    }
    input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.2); }

    /* Inline error messages for each field (hidden by default) */
    .error { color: var(--danger); font-size: 13px; margin-top: 6px; display: none; }

    /* Primary button with gradient + disabled state */
    button {
      padding: 14px 18px; border: none; border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
      box-shadow: 0 8px 20px rgba(37,99,235,.25); transition: filter .2s, opacity .2s;
    }
    button[disabled] { opacity: .7; cursor: not-allowed; }
    button:hover:not([disabled]) { filter: brightness(1.05); }

    /* Response payload viewer (JSON pretty-printed) */
    pre {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px;
      padding: 16px; margin-top: 24px; font-size: 14px; overflow-x: auto;
    }

    /* ---------------- Modal (confirmation step) ---------------- */
    .modal-backdrop {
      /* fixed overlay centered layout */
      position: fixed; inset: 0; background: rgba(2,6,23,.55);
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal {
      width: 100%; max-width: 560px; background: #fff; border-radius: 16px;
      box-shadow: 0 30px 80px rgba(2,6,23,.35); overflow: hidden;
    }
    .modal-header {
      padding: 18px 22px; background: linear-gradient(135deg, var(--bg), #1e293b); color:#fff;
      display:flex; justify-content: space-between; align-items:center;
    }
    .modal-title { font-weight: 700; }
    .close-btn {
      background: transparent; border: none; color: #cbd5e1; font-size: 22px; line-height: 1; cursor: pointer;
    }
    .modal-body { padding: 22px; display: grid; gap: 16px; }

    /* Key-value summary block inside the modal */
    .summary {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #f9fafb;
    }
    .summary dl { margin: 0; display: grid; grid-template-columns: 1fr 2fr; gap: 10px 16px; }
    .summary dt { color: var(--muted); font-weight: 600; }
    .summary dd { margin: 0; font-weight: 700; }

    .modal-footer {
      padding: 18px 22px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid #eef2f7;
    }
    .btn-secondary {
      background: #fff; color: var(--accent); border: 1px solid #d1d5db; box-shadow: none;
    }
    .btn-secondary:hover { background: #f8fafc; }
  </style>
</head>
<body>
  <div class="shell">
    <!-- Header: brand + link back to Home -->
    <div class="header">
      <div class="brand" aria-label="Brand">
        <img th:src="@{/images/amo-logo.png}" alt="@MO Logo" class="brand-logo" />
        <span>Matrix Payment</span>
      </div>
      <a href="/" class="back-link">← Back to Home</a>
    </div>

    <!-- Card containing the payment form and response output -->
    <div class="card">
      <h1>Send Payment</h1>

      <!-- novalidate: we perform custom JS validation for better UX -->
      <form id="paymentForm" novalidate>
        <!-- Blob name: must end with .b64 -->
        <div>
          <label for="blob_name">Blob Name (.b64)</label>
          <input type="text" id="blob_name" value="initial-matrix.b64" required />
          <div class="error" id="err_blob_name">Please enter a blob name ending in .b64</div>
        </div>

        <!-- Sender node (node_a) -->
        <div>
          <label for="node_a">Sender (node_a)</label>
          <input type="text" id="node_a" required />
          <div class="error" id="err_node_a">Please enter a sender (node_a).</div>
        </div>

        <!-- Receiver node (node_b) -->
        <div>
          <label for="node_b">Receiver (node_b)</label>
          <input type="text" id="node_b" required />
          <div class="error" id="err_node_b">Please enter a receiver (node_b).</div>
        </div>

        <!-- Amount: integer >= 1 -->
        <div>
          <label for="amount">Amount</label>
          <input type="number" id="amount" required min="1" step="1" />
          <div class="error" id="err_amount">Please enter a valid positive amount.</div>
        </div>

        <!-- Output filename base (server will add timestamp / suffix) -->
        <div>
          <label for="out_base">Output Base Filename</label>
          <input type="text" id="out_base" value="payment-update" required />
          <div class="error" id="err_out_base">Please enter an output base filename.</div>
        </div>

        <!-- Azure Blob container name -->
        <div>
          <label for="container">Azure Container</label>
          <input type="text" id="container" value="matrices" required />
          <div class="error" id="err_container">Please enter the container name.</div>
        </div>

        <!-- Submit triggers the confirmation modal (does not send yet) -->
        <button type="submit" id="openConfirm">Review & Continue</button>
      </form>

      <!-- API response (pretty JSON) -->
      <pre id="responseMessage" aria-live="polite"></pre>
    </div>
  </div>

  <!-- Confirmation Modal (opened before sending) -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="confirmTitle">Confirm Payment</div>
        <!-- Close button in the modal header -->
        <button class="close-btn" id="closeModal" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <p class="muted">Please review the details before sending.</p>

        <!-- Summary of values pulled from the form -->
        <div class="summary">
          <dl>
            <dt>Blob</dt><dd id="sum_blob_name">—</dd>
            <dt>Sender</dt><dd id="sum_node_a">—</dd>
            <dt>Receiver</dt><dd id="sum_node_b">—</dd>
            <dt>Amount</dt><dd id="sum_amount">—</dd>
            <dt>Output Base</dt><dd id="sum_out_base">—</dd>
            <dt>Container</dt><dd id="sum_container">—</dd>
          </dl>
        </div>

        <!-- Note about the backend endpoint being called -->
        <p class="muted" id="sendNote">The request will be sent to <code>https://api.amo.onl/matrix/payment</code>.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelSend" type="button">Cancel</button>
        <button id="confirmSend" type="button">Confirm &amp; Send</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- Element refs ---------------- */
    const form = document.getElementById('paymentForm');
    const responseEl = document.getElementById('responseMessage');

    // Form fields
    const f_blob = document.getElementById('blob_name');
    const f_a = document.getElementById('node_a');
    const f_b = document.getElementById('node_b');
    const f_amount = document.getElementById('amount');
    const f_out = document.getElementById('out_base');
    const f_container = document.getElementById('container');

    // Error message containers
    const err_blob = document.getElementById('err_blob_name');
    const err_a = document.getElementById('err_node_a');
    const err_b = document.getElementById('err_node_b');
    const err_amount = document.getElementById('err_amount');
    const err_out = document.getElementById('err_out_base');
    const err_container = document.getElementById('err_container');

    // Modal pieces
    const backdrop = document.getElementById('modalBackdrop');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelSendBtn = document.getElementById('cancelSend');
    const confirmSendBtn = document.getElementById('confirmSend');

    // Summary fields in modal
    const sum_blob = document.getElementById('sum_blob_name');
    const sum_a = document.getElementById('sum_node_a');
    const sum_b = document.getElementById('sum_node_b');
    const sum_amt = document.getElementById('sum_amount');
    const sum_out = document.getElementById('sum_out_base');
    const sum_container = document.getElementById('sum_container');

    /* ---------------- Simple client-side validation ----------------
       Shows field-level errors and prevents submit if invalid.
       Rules:
       - blob_name must end with ".b64"
       - node_a, node_b non-empty
       - amount must be integer > 0
       - out_base, container non-empty
    -----------------------------------------------------------------*/
    function validate() {
      let ok = true;

      // reset/hide all errors first
      [err_blob, err_a, err_b, err_amount, err_out, err_container].forEach(el => el.style.display = 'none');

      if (!f_blob.value || !f_blob.value.trim().endsWith('.b64')) { err_blob.style.display = 'block'; ok = false; }
      if (!f_a.value.trim()) { err_a.style.display = 'block'; ok = false; }
      if (!f_b.value.trim()) { err_b.style.display = 'block'; ok = false; }
      const amt = parseInt(f_amount.value, 10);
      if (isNaN(amt) || amt <= 0) { err_amount.style.display = 'block'; ok = false; }
      if (!f_out.value.trim()) { err_out.style.display = 'block'; ok = false; }
      if (!f_container.value.trim()) { err_container.style.display = 'block'; ok = false; }

      return ok;
    }

    /* ---------------- Modal open/close helpers ---------------- */
    function openModal() {
      // Copy form values into the confirmation summary
      sum_blob.textContent = f_blob.value;
      sum_a.textContent = f_a.value;
      sum_b.textContent = f_b.value;
      sum_amt.textContent = f_amount.value;
      sum_out.textContent = f_out.value;
      sum_container.textContent = f_container.value;

      // Display modal and move focus to the primary action
      backdrop.style.display = 'flex';
      confirmSendBtn.focus();
    }

    function closeModal() {
      backdrop.style.display = 'none';
    }

    /* Intercept form submit:
       - run validation
       - if OK, show confirmation modal instead of sending immediately */
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (!validate()) return;
      openModal();
    });

    // Modal close interactions (button + backdrop click)
    closeModalBtn.addEventListener('click', closeModal);
    cancelSendBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });

    /* ---------------- Send the payment ----------------
       POSTs JSON payload to the FastAPI backend.
       Note:
       - If your frontend runs on https://localhost:8443 and backend on https://api.amo.onl,
         ensure CORS is configured on the backend to allow this origin.
       - Response JSON is pretty-printed in the <pre> element. */
    async function sendPayment() {
      const payload = {
        blob_name: f_blob.value,
        node_a: f_a.value,
        node_b: f_b.value,
        amount: parseInt(f_amount.value, 10),
        out_base: f_out.value,
        container: f_container.value
      };

      // Provide immediate feedback on button while the request is in flight
      const originalText = confirmSendBtn.textContent;
      confirmSendBtn.textContent = 'Sending…';
      confirmSendBtn.disabled = true;

      try {
        const response = await fetch('https://api.amo.onl/matrix/payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });

        // If response is not JSON or backend returned non-2xx, handle gracefully
        const result = await response.json().catch(() => ({ error: 'Invalid JSON response' }));
        // Show status code alongside the payload for easier debugging
        responseEl.textContent = JSON.stringify({ status: response.status, ...result }, null, 2);
      } catch (err) {
        // Network or CORS errors land here
        responseEl.textContent = 'Error: ' + err.message;
      } finally {
        // Restore button and close modal regardless of outcome
        confirmSendBtn.textContent = originalText;
        confirmSendBtn.disabled = false;
        closeModal();
      }
    }

    // Final confirmation click triggers the POST
    confirmSendBtn.addEventListener('click', sendPayment);
  </script>
</body>
</html>
